# websocket客户端

## 部分参考:

 [32_Drive/ESP32/websocket客户端接收文本和二进制数据 at main · gybpersist/32_Drive](https://github.com/gybpersist/32_Drive/tree/main/ESP32/websocket客户端接收文本和二进制数据) 

## 组件:

 [espressif/esp_websocket_client • v1.5.0 • ESP Component Registry](https://components.espressif.com/components/espressif/esp_websocket_client/versions/1.5.0/readme) 

```c
idf.py add-dependency "espressif/esp_websocket_client^1.5.0"
```

## Dri_websocket.c

```c
#include "Dri_websocket.h"

// 接收到文本数据的回调函数
static ws_text_cb text_cb;
// 接收到二进制数据的回调函数
static ws_bin_cb bin_cb;
// 结束的回调函数
static ws_finish_cb finish_cb;

// 会话ID
char session_id[9] = {0};

// WebSocket客户端
esp_websocket_client_handle_t client;

// 事件标志组
EventGroupHandle_t ws_eventgroup;

static const char *TAG = "websocket";

static void log_error_if_nonzero(const char *message, int error_code)
{
    if (error_code != 0)
    {
        ESP_LOGE(TAG, "Last error %s: 0x%x", message, error_code);
    }
}

static void websocket_event_handler(void *handler_args, esp_event_base_t base, int32_t event_id, void *event_data)
{
    esp_websocket_event_data_t *data = (esp_websocket_event_data_t *)event_data;
    switch (event_id)
    {
    case WEBSOCKET_EVENT_BEGIN:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_BEGIN");
        break;
    case WEBSOCKET_EVENT_CONNECTED: // 连接成功
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_CONNECTED");
        // 设置WebSocket客户端连接成功事件标志
        xEventGroupSetBits(ws_eventgroup, WS_CONNECTED_EVENT);
        break;
    case WEBSOCKET_EVENT_DISCONNECTED: // 关闭连接
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_DISCONNECTED");
        log_error_if_nonzero("HTTP status code", data->error_handle.esp_ws_handshake_status_code);
        if (data->error_handle.error_type == WEBSOCKET_ERROR_TYPE_TCP_TRANSPORT)
        {
            log_error_if_nonzero("reported from esp-tls", data->error_handle.esp_tls_last_esp_err);
            log_error_if_nonzero("reported from tls stack", data->error_handle.esp_tls_stack_err);
            log_error_if_nonzero("captured as transport's socket errno", data->error_handle.esp_transport_sock_errno);
        }
        break;
    case WEBSOCKET_EVENT_DATA: // 接收到数据
        // ESP_LOGI(TAG, "WEBSOCKET_EVENT_DATA");
        // ESP_LOGI(TAG, "Received opcode=%d", data->op_code);
        if (data->op_code == 0x1)
        { // 操作码0x1表示文本数据
            if (text_cb != NULL)
            {
                // 回调函数
                text_cb(data->data_ptr, data->data_len);
            }
        }
        // 操作码0x2表示二进制数据,即opus音频数据
        else if (data->op_code == 0x2)
        {
            // ESP_LOG_BUFFER_HEX("Received binary data", data->data_ptr, data->data_len);
            if (bin_cb != NULL)
            {
                // 回调函数
                bin_cb(data->data_ptr, data->data_len);
            }
        }
        break;
    case WEBSOCKET_EVENT_ERROR:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_ERROR");
        log_error_if_nonzero("HTTP status code", data->error_handle.esp_ws_handshake_status_code);
        if (data->error_handle.error_type == WEBSOCKET_ERROR_TYPE_TCP_TRANSPORT)
        {
            log_error_if_nonzero("reported from esp-tls", data->error_handle.esp_tls_last_esp_err);
            log_error_if_nonzero("reported from tls stack", data->error_handle.esp_tls_stack_err);
            log_error_if_nonzero("captured as transport's socket errno", data->error_handle.esp_transport_sock_errno);
        }
        break;
    case WEBSOCKET_EVENT_FINISH:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_FINISH");
        // 回调函数
        if (finish_cb != NULL)
        {
            finish_cb();
        }

        break;
    }
}

/**
 * @brief 初始化 WebSocket客户端
 *
 * @param cb1 接收到文本数据的回调函数
 * @param cb2 接收到二进制数据的回调函数
 */
void Dri_websocket_Init(ws_text_cb cb1, ws_bin_cb cb2, ws_finish_cb cb3)
{
    // 保存回调函数
    text_cb = cb1;
    bin_cb = cb2;
    finish_cb = cb3;

    // 配置WebSocket客户端
    esp_websocket_client_config_t websocket_cfg = {
        .uri = WS_URL,
        .buffer_size = 4096,
        .transport = WEBSOCKET_TRANSPORT_OVER_SSL,
        .crt_bundle_attach = esp_crt_bundle_attach,

    };
    // 初始化客户端
    client = esp_websocket_client_init(&websocket_cfg);
    // 注册事件回调
    esp_websocket_register_events(client, WEBSOCKET_EVENT_ANY, websocket_event_handler, (void *)client);

    // 添加头部信息
    esp_websocket_client_append_header(client, "Authorization", "Bearer " ACCESS_TOKEN);
    esp_websocket_client_append_header(client, "Protocol-Version", "1");
    esp_websocket_client_append_header(client, "Device-Id", Com_Get_MAC());
    esp_websocket_client_append_header(client, "Client-Id", Com_Get_UUID());

    // 创建事件标志组
    ws_eventgroup = xEventGroupCreate();
}

/**
 * @brief 启动 WebSocket客户端
 *
 */
void Dri_websocket_Start(void)
{ // 检查客户端是否创建成功且未连接成功
    if (client != NULL && !esp_websocket_client_is_connected(client))
    {
        MY_LOGE("websocket is start...\r\n");
        esp_websocket_client_start(client);

        // 等待事件标志（连接状态）
        xEventGroupWaitBits(ws_eventgroup, WS_CONNECTED_EVENT, true, true, portMAX_DELAY);
    }
}

/**
 * @brief 关闭 WebSocket客户端
 *
 */
void Dri_websocket_Close(void)
{ // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        MY_LOGE("websocket is close...\r\n");
        esp_websocket_client_close(client, portMAX_DELAY);
    }
}

/**
 * @brief 发送 hello 消息
 *
 */
void Dri_websocket_SendHello(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send Hello is OK...\r\n");

        // 组装cJSON对象
        cJSON *root = cJSON_CreateObject();
        cJSON_AddStringToObject(root, "type", "hello");
        cJSON_AddNumberToObject(root, "version", 1);
        cJSON_AddStringToObject(root, "transport", "websocket");

        cJSON *audio_params = cJSON_CreateObject();
        cJSON_AddStringToObject(audio_params, "format", "opus");
        cJSON_AddNumberToObject(audio_params, "sample_rate", 16000);
        cJSON_AddNumberToObject(audio_params, "channels", 1);
        cJSON_AddNumberToObject(audio_params, "frame_duration", 60);
        cJSON_AddItemToObject(root, "audio_params", audio_params);

        // 转换为cJSON字符串
        char *root_str = cJSON_PrintUnformatted(root);

        // 发送文本消息
        esp_websocket_client_send_text(client, root_str, strlen(root_str), portMAX_DELAY);

        xEventGroupWaitBits(ws_eventgroup, WS_HELLO_EVENT, true, true, portMAX_DELAY);
        // 释放资源
        cJSON_Delete(root);
        free(root_str);

        // 等待事件标志（等待接收到hello消息）
    }
    else
    {
        MY_LOGE("websocket Send Hello is ERROR...\r\n");
    }
}

/**
 * @brief 发送 唤醒词
 *
 */
void Dri_websocket_SendWakeNet(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send WakeNet is OK...\r\n");

        // 组装cJSON对象
        cJSON *root = cJSON_CreateObject();
        cJSON_AddStringToObject(root, "session_id", session_id);
        cJSON_AddStringToObject(root, "type", "listen");
        cJSON_AddStringToObject(root, "text", "你好小智");
        cJSON_AddStringToObject(root, "state", "detect");

        // 转换为cJSON字符串
        char *root_str = cJSON_PrintUnformatted(root);

        // 发送文本消息
        esp_websocket_client_send_text(client, root_str, strlen(root_str), portMAX_DELAY);

        // 释放资源
        cJSON_Delete(root);
        free(root_str);
    }
    else
    {
        MY_LOGE("websocket Send WakeNet is ERROR...\r\n");
    }
}

/**
 * @brief 开始 监听消息
 *
 */
void Dri_websocket_SendStartListen(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send start listen is OK...\r\n");

        // 组装cJSON对象
        cJSON *root = cJSON_CreateObject();
        cJSON_AddStringToObject(root, "session_id", session_id);
        cJSON_AddStringToObject(root, "mode", "auto");
        cJSON_AddStringToObject(root, "type", "listen");
        cJSON_AddStringToObject(root, "state", "start");

        // 转换为cJSON字符串
        char *root_str = cJSON_PrintUnformatted(root);

        MY_LOGE("Send Listen:%.*s", strlen(root_str), root_str);
        // 发送文本消息
        esp_websocket_client_send_text(client, root_str, strlen(root_str), portMAX_DELAY);

        // 释放资源
        cJSON_Delete(root);
        free(root_str);
    }
    else
    {
        MY_LOGE("websocket Send start listen is ERROR...\r\n");
    }
}

/**
 * @brief 停止 监听信息
 *
 */
void Dri_websocket_SendStopListen(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send stop listen is OK...\r\n");

        // 组装cJSON对象
        cJSON *root = cJSON_CreateObject();
        cJSON_AddStringToObject(root, "session_id", session_id);
        cJSON_AddStringToObject(root, "type", "listen");
        cJSON_AddStringToObject(root, "state", "stop");

        // 转换为cJSON字符串
        char *root_str = cJSON_PrintUnformatted(root);

        // 发送文本消息
        esp_websocket_client_send_text(client, root_str, strlen(root_str), portMAX_DELAY);

        // 释放资源
        cJSON_Delete(root);
        free(root_str);
    }
    else
    {
        MY_LOGE("websocket Send stop listen is ERROR...\r\n");
    }
}

/**
 * @brief 发送 打断请求
 *
 */
void Dri_websocket_SendAbort(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send Abort is OK...\r\n");

        // 组装cJSON对象
        cJSON *root = cJSON_CreateObject();
        cJSON_AddStringToObject(root, "session_id", session_id);
        cJSON_AddStringToObject(root, "type", "abort");
        cJSON_AddStringToObject(root, "reason", "wake_word_detected");

        // 转换为cJSON字符串
        char *root_str = cJSON_PrintUnformatted(root);
        MY_LOGE("Send Abort:%.*s", strlen(root_str), root_str);
        // 发送文本消息
        esp_websocket_client_send_text(client, root_str, strlen(root_str), portMAX_DELAY);

        // 释放资源
        cJSON_Delete(root);
        free(root_str);
    }
    else
    {
        MY_LOGE("websocket Send Abort is ERROR...\r\n");
    }
}

/**
 * @brief 发送 Opus语音到服务器
 *
 * @param data  Opus语音数据
 * @param len 数据长度
 */
void Dri_websocket_SendOpusTOService(void *data, int len)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        esp_websocket_client_send_bin(client, (char *)data, len, portMAX_DELAY);
    }
    else
    {
        MY_LOGE("websocket SendOpusTOService is ERROR...\r\n");
    }
}

/**
 * @brief 发送需要AI控制的外设
 *
 */
void Dri_websocket_Send_iot_dev(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send iot_dev is OK...\r\n");

        // 组装cJSON字符串
        // char *data1 = "{\"descriptors\":[{\"description\":\"Speaker\",\"methods\":{\"SetMute\":{\"description\":\"Set mute status\",\"parameters\":{\"mute\":{\"description\":\"Mute status\",\"type\":\"boolean\"}}},\"SetVolume\":{\"description\":\"Set volume level\",\"parameters\":{\"volume\":{\"description\":\"Volume level[0-100]\",\"type\":\"number\"}}}},\"name\":\"Speaker\",\"properties\":{\"mute\":{\"description\":\"Mute status\",\"type\":\"boolean\"},\"volume\":{\"description\":\"Volume level[0-100]\",\"type\":\"number\"}}}],\"session_id\":\"";
        // char *data2 = "\",\"type\":\"iot\",\"update\":true}";
        char *data1 = "{\"descriptors\":[{\"description\":\"Speaker\",\"methods\":{\"SetMute\":{\"description\":\"Set mute status\",\"parameters\":{\"mute\":{\"description\":\"Mute status\",\"type\":\"boolean\"}}},\"SetVolume\":{\"description\":\"Set volume level\",\"parameters\":{\"volume\":{\"description\":\"Volume level[0-100]\",\"type\":\"number\"}}}},\"name\":\"Speaker\",\"properties\":{\"mute\":{\"description\":\"Mute status\",\"type\":\"boolean\"},\"volume\":{\"description\":\"Volume level[0-100]\",\"type\":\"number\"}}},{\"description\":\"LED strip\",\"methods\":{\"TurnOn\":{\"description\":\"Turn on the LED strip\",\"parameters\":{}},\"TurnOff\":{\"description\":\"Turn off the LED strip\",\"parameters\":{}}},\"name\":\"LEDStrip\",\"properties\":{\"power\":{\"description\":\"Power status of LED strip\",\"type\":\"boolean\"}}}],\"session_id\":\"";
        char *data2 = "\",\"type\":\"iot\",\"update\":true}";

        size_t data1_len = strlen(data1);
        size_t data2_len = strlen(data2);
        char *json_str = (char *)heap_caps_malloc(strlen(data1) + strlen(data2) + 8, MALLOC_CAP_SPIRAM);
        memcpy(json_str, data1, data1_len);
        memcpy(json_str + data1_len, session_id, 8);
        memcpy(json_str + data1_len + 8, data2, data2_len);

        // 发送文本消息
        esp_websocket_client_send_text(client, json_str, data1_len + data2_len + 8, portMAX_DELAY);

        // 释放资源
        free(json_str);
    }
    else
    {
        MY_LOGE("websocket Send iot_dev is ERROR...\r\n");
    }
}

/**
 * @brief 发送需要AI控制的外设当前的状态
 *
 */
void Dri_websocket_Send_iot_dev_status(void)
{
    // 检查客户端是否创建成功且连接成功
    if (client != NULL && esp_websocket_client_is_connected(client))
    {
        // MY_LOGE("websocket Send iot_dev_status is OK...\r\n");

        // 组装cJSON字符串
        // char *data1 = "{\"session_id\": \"";
        // char *data2 = "\",\"states\": [{\"name\": \"Speaker\",\"state\": {\"mute\": false,\"volume\": 60}}],\"type\": \"iot\",\"update\": true}";
        char *data1 = "{\"session_id\": \"";
        char *data2 = "\",\"states\": [{\"name\": \"Speaker\",\"state\": {\"mute\": false,\"volume\": 60}},{\"name\": \"LEDStrip\",\"state\": {\"power\": false}}],\"type\": \"iot\",\"update\": true}";

        size_t data1_len = strlen(data1);
        size_t data2_len = strlen(data2);
        char *json_str = (char *)heap_caps_malloc(strlen(data1) + strlen(data2) + 8, MALLOC_CAP_SPIRAM);
        memcpy(json_str, data1, data1_len);
        memcpy(json_str + data1_len, session_id, 8);
        memcpy(json_str + data1_len + 8, data2, data2_len);

        // 发送文本消息
        esp_websocket_client_send_text(client, json_str, data1_len + data2_len + 8, portMAX_DELAY);

        // 释放资源
        free(json_str);
    }
    else
    {
        MY_LOGE("websocket Send iot_dev_status is ERROR...\r\n");
    }
}
```

## Dri_websocket.h

```c
#ifndef __DRI_WEBSOCKET_H__
#define __DRI_WEBSOCKET_H__

#include <stdio.h>
#include "esp_wifi.h"
#include "esp_system.h"
#include "nvs_flash.h"
#include "esp_event.h"
#include "esp_crt_bundle.h"

#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/semphr.h"
#include "freertos/event_groups.h"

#include "esp_log.h"
#include "esp_websocket_client.h"
#include "esp_event.h"
#include <cJSON.h>
#include "Com_Util.h"

#define WS_URL "wss://api.tenclass.net/xiaozhi/v1/"
#define ACCESS_TOKEN "test-token"

// 定义 接收到文本数据后的回调函数
typedef void (*ws_text_cb)(const char *, int);
// 定义 接收到二进制数据后的回调函数
typedef void (*ws_bin_cb)(const char *, int);
// 定义 结束的回调函数
typedef void (*ws_finish_cb)(void);

// 创建事件标志组
extern EventGroupHandle_t ws_eventgroup;
// websocket客户端连接成功的事件标志
#define WS_CONNECTED_EVENT (1 << 1)
// 接收到HELLO消息的事件标志
#define WS_HELLO_EVENT (1 << 2)

// 定义session_id
extern char session_id[9];

/**
 * @brief 初始化 websocket客户端
 *
 * @param cb1 接收到文本数据后的回调函数
 * @param cb2 接收到二进制数据后的回调函数
 */
void Dri_websocket_Init(ws_text_cb cb1, ws_bin_cb cb2, ws_finish_cb cb3);

/**
 * @brief 开启 websocket客户端
 *
 */
void Dri_websocket_Start(void);

/**
 * @brief 关闭 websocket客户端
 *
 */
void Dri_websocket_Close(void);

/**
 * @brief 发送 hello 消息
 *
 */
void Dri_websocket_SendHello(void);

/**
 * @brief 发送 唤醒词
 *
 */
void Dri_websocket_SendWakeNet(void);

/**
 * @brief 开始 监听信息
 *
 */
void Dri_websocket_SendStartListen(void);

/**
 * @brief 停止 监听信息
 *
 */
void Dri_websocket_SendStopListen(void);

/**
 * @brief 发送 打断请求
 *
 */
void Dri_websocket_SendAbort(void);

/**
 * @brief 发送 Opus语音到服务器
 *
 * @param data  Opus语音数据
 * @param len 数据长度
 */
void Dri_websocket_SendOpusTOService(void *data, int len);

/**
 * @brief 发送需要AI控制的外设
 *
 */
void Dri_websocket_Send_iot_dev(void);

/**
 * @brief 发送需要AI控制的外设当前的状态
 *
 */
void Dri_websocket_Send_iot_dev_status(void);

#endif /* __DRI_WEBSOCKET_H__ */
```

